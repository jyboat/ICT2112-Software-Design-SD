@model List<ClearCare.Models.NurseAvailability>

@{
    ViewData["Title"] = "Nurse Availability";
}

<h2>Nurse Availability</h2>

<table class="table">
    <thead>
        <tr>
            <th>Availability ID</th>
            <th>Nurse ID</th>
            <th>Date</th>
            <th>Start Time</th>
            <th>End Time</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @if (Model != null && Model.Any())
        {
            @foreach (var availability in Model)
            {
                var details = availability.GetAvailabilityDetails();
                <tr>
                    <td>@details["availabilityId"]</td>
                    <td>@details["nurseID"]</td>
                    <td>@details["date"]</td>
                    <td>@details["startTime"]</td>
                    <td>@details["endTime"]</td>

                    <td>
                        <!-- Edit Button -->
                        <a href="javascript:void(0);" class="btn btn-warning"
                            onclick="openEditModal(@details["availabilityId"], '@details["nurseID"]', '@details["date"]', '@details["startTime"]', '@details["endTime"]')">Edit</a>

                        <!-- Delete Button -->
                        <form method="post" action="/NurseAvailability/Delete/@details["availabilityId"]"
                            style="display:inline;">
                            <button type="submit" class="btn btn-danger"
                                onclick="return confirm('Are you sure you want to delete this availability?');">
                                Delete
                            </button>
                        </form>

                    </td>
                </tr>
            }
        }
        else
        {
            <tr>
                <td colspan="6" class="text-center">No availability records found.</td>
            </tr>
        }
    </tbody>
</table>

<a asp-controller="NurseAvailability" asp-action="AddAvailability" class="btn btn-primary">Add Availability</a>

<!-- Edit Modal -->
<div id="editAvailabilityModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Availability</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editAvailabilityForm">
                    <input type="hidden" id="editAvailabilityId">
                    <div class="form-group">
                        <label for="editNurseID">Nurse ID</label>
                        <input type="text" class="form-control" id="editNurseID" readonly>
                    </div>
                    <div class="form-group">
                        <label for="editDate">Date</label>
                        <input type="date" class="form-control" id="editDate">
                    </div>
                    <div class="form-group">
                        <label for="editStartTime">Start Time</label>
                        <input type="time" class="form-control" id="editStartTime">
                    </div>
                    <div class="form-group">
                        <label for="editEndTime">End Time</label>
                        <input type="time" class="form-control" id="editEndTime">
                    </div>
                    <button type="button" class="btn btn-primary" onclick="updateAvailability()">Save Changes</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
    function openEditModal(id, nurseId, date, startTime, endTime) {
        document.getElementById("editAvailabilityId").value = id;
        document.getElementById("editNurseID").value = nurseId;
        document.getElementById("editDate").value = date;
        document.getElementById("editStartTime").value = startTime;
        document.getElementById("editEndTime").value = endTime;
        $('#editAvailabilityModal').modal('show');
    }

    function updateAvailability() {
        let id = document.getElementById("editAvailabilityId").value;
        let nurseID = document.getElementById("editNurseID").value;
        let date = document.getElementById("editDate").value;
        let startTime = document.getElementById("editStartTime").value;
        let endTime = document.getElementById("editEndTime").value;

        fetch("/NurseAvailability/Update", {
            method: "POST", // ðŸ”¹ Ensure it's POST
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: new URLSearchParams({
                availabilityId: id,
                nurseID: nurseID,
                date: date,
                startTime: startTime,
                endTime: endTime
            })
        }).then(response => {
            if (response.ok) {
                alert("Availability updated successfully!");
                location.reload();
            } else {
                alert("Error updating availability.");
            }
        }).catch(error => console.error("Error:", error));
    }
</script>
