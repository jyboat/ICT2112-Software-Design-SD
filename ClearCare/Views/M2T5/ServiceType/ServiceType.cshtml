@model List<ClearCare.Models.Entities.ServiceType_SDM>

@{
    ViewData["Title"] = "Service Types";
}

<h2>Service Types</h2>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}


<!-- Button to trigger add service modal & search bar -->
<div class="d-flex justify-content-between align-items-center mb-3 gap-2 flex-wrap">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addServiceModal">
        Add a Service
    </button>

    <!-- Sort Dropdown -->
    <div>
        <select id="sortDropdown" class="form-select">
            <option value="">Sort By...</option>
            <option value="name">Name (A-Z)</option>
            <option value="modality">Modality (A-Z)</option>
        </select>
    </div>

    <div style="position: relative; max-width: 400px; width: 100%;">
        <input type="text" id="liveSearch" class="form-control" placeholder="Search services..." autocomplete="on" />
        <ul id="searchResults" class="list-group position-absolute w-100 z-3"
            style="top: 100%; max-height: 200px; overflow-y: auto;"></ul>
    </div>
</div>

<div class="table-responsive">
    <table id="servicesTable" class="table table-striped table-hover table-bordered">
        <thead class="table-primary">
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Duration</th>
                <th>Modality</th>
                <th>Requirements</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        @{
            var index = 1;
            foreach (var service in Model)
            {
                <tr id="service-@service.ServiceTypeId">
                    <td>@index</td> <!-- Index instead of ServiceTypeId -->
                    <td>@service.Name</td>
                    <td>@service.Duration</td>
                    <td>@service.Modality</td>
                    <td>@service.Requirements</td>
                    <td>
                        @if (service.Status == "discontinued")
                        {
                            <span class="badge bg-secondary">Discontinued</span>
                        }
                        else
                        {
                            <div class="d-flex gap-2">
                                <button class="btn btn-warning" data-bs-toggle="modal"
                                        data-bs-target="#editServiceModal-@service.ServiceTypeId">
                                    Edit
                                </button>
                                <button class="btn btn-danger" onclick="loadDiscontinueModal(@service.ServiceTypeId)">
                                    Discontinue
                                </button>
                            </div>
                        }
                    </td>

                </tr>
                index++;
            }
        }
        </tbody>


    </table>
</div>

<!-- Modal container -- Discontinue service -->
<div class="modal fade" id="discontinueModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" id="discontinueModalContent"></div>
    </div>
</div>


<script>
    function loadDiscontinueModal(serviceId) {
        fetch(`/ServiceTypeInput/ConfirmDiscontinue/${serviceId}`)
            .then(response => response.text())
            .then(html => {
                document.getElementById("discontinueModalContent").innerHTML = html;
                new bootstrap.Modal(document.getElementById("discontinueModal")).show();
            });
    }
</script>


<!-- Add Service Modal -->
<div class="modal fade" id="addServiceModal" tabindex="-1" aria-labelledby="addServiceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addServiceModalLabel">Add New Service</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form asp-action="Create" asp-controller="ServiceTypeInput" method="post">
                    <div class="mb-3">
                        <label for="serviceName" class="form-label">Service Name</label>
                        <input type="text" class="form-control" id="serviceName" name="name" required>
                        <div class="invalid-feedback">Service name is required.</div>
                    </div>
                    <div class="mb-3">
                        <label for="serviceDuration" class="form-label">Duration (minutes)</label>
                        <input type="number" class="form-control" id="serviceDuration" name="duration" min="60" required>
                        <div class="invalid-feedback">Service duration must be at least 60 minute.</div>
                    </div>
                    <div class="mb-3">
                        <label for="modality" class="form-label">Modality</label>
                        <select class="form-control" id="modality" name="modality" required>
                            <option value="">-- Select Modality --</option>
                            <option value="Virtual">Virtual</option>
                            <option value="Physical (Level 1 Room A)">Physical (Level 1 Room A)</option>
                            <option value="Physical (Level 2 Room B)">Physical (Level 2 Room B)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="serviceRequirements" class="form-label">Requirements</label>
                        <textarea class="form-control" id="serviceRequirements" name="requirements" required></textarea>
                        <div class="invalid-feedback">Service requirements are required.</div>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Service</button>
                </form>
            </div>
        </div>
    </div>
</div>


@foreach (var service in Model)
{
    <div class="modal fade" id="editServiceModal-@service.ServiceTypeId" tabindex="-1"
        aria-labelledby="editServiceModalLabel-@service.ServiceTypeId" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editServiceModalLabel-@service.ServiceTypeId">Edit Service</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form asp-action="Edit" asp-controller="ServiceTypeInput" method="post">
                        <input type="hidden" name="id" value="@service.ServiceTypeId" />
                        <div class="mb-3">
                            <label for="editServiceName-@service.ServiceTypeId" class="form-label">Service Name</label>
                            <input type="text" class="form-control" id="editServiceName-@service.ServiceTypeId" name="name"
                                value="@service.Name" required>
                        </div>
                        <div class="mb-3">
                            <label for="editServiceDuration-@service.ServiceTypeId" class="form-label">Duration
                                (minutes)</label>
                            <input type="number" class="form-control" id="editServiceDuration-@service.ServiceTypeId"
                                name="duration" value="@service.Duration" required>
                        </div>
                        <select class="form-control" name="modality" required>
                            @if (service.Modality == "Virtual")
                            {
                                <option value="Virtual" selected>Virtual</option>
                            }
                            else
                            {
                                <option value="Virtual">Virtual</option>
                            }
                            @if (service.Modality == "Physical (Level 1 Room A)")
                            {
                                <option value="Physical (Level 1 Room A)" selected>Physical (Level 1 Room A)</option>
                            }
                            else
                            {
                                <option value="Physical (Level 1 Room A)">Physical (Level 1 Room A)</option>
                            }
                            @if (service.Modality == "Physical (Level 2 Room B)")
                            {
                                <option value="Physical (Level 2 Room B)" selected>Physical (Level 2 Room B)</option>
                            }
                            else
                            {
                                <option value="Physical (Level 2 Room B)">Physical (Level 2 Room B)</option>
                            }

                        </select>
                        <div class="mb-3">
                            <label for="editServiceRequirements-@service.ServiceTypeId"
                                class="form-label">Requirements</label>
                            <textarea class="form-control" id="editServiceRequirements-@service.ServiceTypeId"
                                name="requirements" required>@service.Requirements</textarea>
                        </div>
                        <button type="submit" class="btn btn-success">Save Changes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
}



<!-- Delete Confirmation Script -->
<script>
    function confirmDelete(serviceId, serviceName) {
        if (confirm("Are you sure you want to delete " + serviceName + "?")) {
            window.location.href = "/ServiceTypeInput/Delete/" + serviceId;
        }
    }
</script>

@section Scripts {
    <script>
        // Live search functionality
        const input = document.getElementById("liveSearch");

        input.addEventListener("input", function () {
            const searchTerm = this.value.trim().toLowerCase();
            const rows = document.querySelectorAll("#servicesTable tbody tr");

            rows.forEach(row => {
                const name = row.children[1].textContent.trim().toLowerCase(); // Name column
                const modality = row.children[3].textContent.trim().toLowerCase(); // Modality column
                const requirements = row.children[4].textContent.trim().toLowerCase(); // Requirements column

                // Reset visibility if search is empty
                if (searchTerm === "") {
                    row.style.display = "";
                }
                else if (
                    name.includes(searchTerm) ||
                    modality.includes(searchTerm) ||
                    requirements.includes(searchTerm)
                ) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        });


        document.addEventListener("click", (e) => {
            if (!e.target.closest("#liveSearch")) {
                resultsList.innerHTML = "";
            }
        });

        // Sorting

        document.getElementById("sortDropdown").addEventListener("change", function () {
            const columnMap = {
                "name": 1,
                "modality": 3
            };

            const sortBy = this.value;
            const columnIndex = columnMap[sortBy];
            if (!columnIndex && columnIndex !== 0) return;

            const table = document.getElementById("servicesTable");
            const rows = Array.from(table.querySelectorAll("tbody tr"));

            rows.sort((a, b) => {
                const aText = a.children[columnIndex].textContent.trim().toLowerCase();
                const bText = b.children[columnIndex].textContent.trim().toLowerCase();
                return aText.localeCompare(bText);
            });

            rows.forEach((row, i) => {
                row.querySelector("td").textContent = i + 1;
                table.querySelector("tbody").appendChild(row);
            });
        });

    </script>
}
